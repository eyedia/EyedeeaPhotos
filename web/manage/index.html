<!DOCTYPE HTML>
<html>

<head>
    <title>Eyedeea Photos</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
</head>

<body class="is-preload">

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Main -->
        <div id="main">
            <div class="inner">

                <!-- Header -->
                <header id="header">
                    <a href="index.html" class="logo"><strong>Editorial</strong> by HTML5 UP</a>
                    <ul class="icons">
                        <li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
                        <li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
                        <li><a href="#" class="icon brands fa-snapchat-ghost"><span class="label">Snapchat</span></a>
                        </li>
                        <li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
                        <li><a href="#" class="icon brands fa-medium-m"><span class="label">Medium</span></a></li>
                    </ul>
                </header>
                <!-- Content -->
                <section>
                    <header class="main">
                        <h1>Photo Sources</h1>
                        <div id="div_msg" name="div_msg" class="col-12" style="visibility:hidden;">
                            <p id="msg" name="msg">Saved successfully.</p>
                            <span id="auth_status_caption" name="auth_status_caption">Authentication Status</span>
                            <span id="auth_status_value" name="auth_status_value" class="inline-p">Success</span>
                        </div>
                    </header>
                    <div class="row gtr-200">
                        <div class="col-6 col-12-medium">
                            <div class="row gtr-uniform">
                                <div class="col-6 col-12-xsmall">
                                    <input type="text" name="name" id="name" value="" placeholder="Name"
                                        oninput="checkFields()" autofocus />
                                </div>
                                <div class="col-6 col-12-xsmall">
                                    <div class="col-12">
                                        <select name="source_type" id="source_type">
                                            <option value="">- Type -</option>
                                            <option value="nas">Synology NAS</option>
                                            <option value="fs">File System</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <input type="text" name="url" id="url" value=""
                                        placeholder="https://SYNOLOGY-IP:5001/webapi" oninput="checkFields()" />
                                </div>
                                <div class="col-6 col-12-xsmall">
                                    <input type="text" name="user_name" id="user_name" value="" placeholder="User Name"
                                        oninput="checkFields()" />
                                </div>
                                <div class="col-6 col-12-xsmall">
                                    <input type="password" name="password" id="password" value="" placeholder="Password"
                                        oninput="checkFields()" />
                                </div>
                                <div id="google_api_key" name="google_api_key" class="col-12" style="visibility:hidden">
                                    <input type="text" name="url_fs" id="url_fs" value=""
                                        placeholder="Google Geo API Key (Optional)" />
                                </div>
                                <!-- Break -->
                                <div class="col-12">
                                    <ul class="actions">
                                        <li><input id="add" name="add" type="submit" value="Add" class="primary"
                                                disabled /></li>
                                        <li><input type="reset" value="Cancel" /></li>
                                    </ul>
                                </div>
                            </div>

                        </div>
                    </div>

                </section>

            </div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar">
            <div class="inner">

                <!-- Search -->
                <section id="search" class="alt">
                    <form method="post" action="#">
                        <input type="text" name="query" id="query" placeholder="Search" />
                    </form>
                </section>

                <!-- Menu -->
                <nav id="menu">
                    <header class="major">
                        <h2>Eyedeea Photos</h2>
                    </header>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li>
                            <span class="opener">Sources</span>
                            <ul>
                                <li><a href="nas.html">Synology</a></li>
                                <li><a href="#">My USB</a></li>
                                <li><a href="#">Tempus Magna</a></li>
                                <li><a href="#">Feugiat Veroeros</a></li>
                            </ul>
                        </li>
                        <li><a href="generic.html">Scans</a></li>
                    </ul>
                </nav>

                <!-- Section -->
                <section>
                    <header class="major">
                        <h2>Get in touch</h2>
                    </header>
                    <ul class="contact">
                        <li class="icon solid fa-envelope"><a href="#">support@eyediatech.com</a></li>
                    </ul>
                </section>

                <!-- Footer -->
                <footer id="footer">
                    <p class="copyright">&copy; Eyedia Technologies. All rights reserved.</p>
                </footer>

            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/manage_main.js"></script>
    <script>
        const add = document.getElementById('add');
        const source_type = document.getElementById('source_type');
        const google_api_key = document.getElementById('google_api_key');
        const name = document.getElementById('name');
        const url = document.getElementById('url');
        const user_name = document.getElementById('user_name');
        const password = document.getElementById('password');


        add.addEventListener('click', function (event) {
            const data = {
                "name": name.value,
                "type": source_type.value,
                "url": url.value,
                "user": user_name.value,
                "password": password.value
            }
            console.log(data);

            makePostRequest('/api/sources', data);
        });

        source_type.addEventListener('change', function (event) {
            if (event.target.value === 'fs') {
                google_api_key.style.visibility = 'visible';
                url.placeholder = "D:\\My_Photos";
                user_name.placeholder = "User Name(Optional)";
                password.placeholder = "Password(Optional)";
            } else {
                google_api_key.style.visibility = 'hidden';
                url.placeholder = "https://SYNOLOGY-IP:5001/webapi";
                user_name.placeholder = "User Name";
                password.placeholder = "Password";
            }
            checkFields();
        });

        async function makePostRequest(url, data) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const responseData = await response.json();
                if ((response.status == 201) || (response.status == 200)) {
                    console.log('New source has been registered with id:', responseData.id);
                    toggle_message(true, "Saved successfully!", responseData.authenticate.auth_status);
                    setTimeout(function () { toggle_message(); }, 5000);
                }
                return responseData;
            } catch (error) {
                console.error('Error:', error.message);
                toggle_message(true, error.message, "Failed");
                setTimeout(function () { toggle_message(); }, 5000);
            }
        }

        function checkFields() {
            if ((name.value.trim() === "") || (url.value.trim() === "") || (source_type.value === '')) {
                add.disabled = true;
                return;
            }
            if (source_type.value === 'nas') {
                if ((user_name.value.trim() === "") || (password.value.trim() === "")) {
                    add.disabled = true;
                    return;
                }
                add.disabled = !isValidURL(url.value);
                return;
            } else {
                add.disabled = !isValidDirectoryPath(url.value);
                return;
            }
            add.disabled = false;
        }

        function isValidDirectoryPath(path) {
            const first_check = /[:/\\/]/.test(path);
            if(!first_check) return false;
            console.log(first_check);
            const pathRegex = /^(?:[a-zA-Z]:\\|\\\\|\/|\.\/|~\/)?(?:[\w.-]+[\\\/])*[\w.-]+$/;
            return pathRegex.test(path);
        }
        function isValidURL(url) {    
            const urlRegex = /^(https?:\/\/)?([\w.-]+)\.([a-z]{2,6})([\/\w .-]*)*\/?$/i;
            return urlRegex.test(url);        }


        function toggle_message(show, msg_text, auth_status) {
            console.log(msg_text, auth_status)
            const div_msg = document.getElementById('div_msg');
            const msg = document.getElementById('msg');
            const auth_status_caption = document.getElementById('auth_status_caption');
            const auth_status_value = document.getElementById('auth_status_value');
            console.log(msg.hidden)
            if (show) {
                msg.textContent = msg_text;
                div_msg.style.visibility = 'visible';
                // auth_status_caption.style.visibility = 'visible';
                // auth_status_value.style.visibility = 'visible';
            } else {
                msg.textContent = "";
                div_msg.style.visibility = 'hidden';
                // auth_status_caption.style.visibility = 'hidden';
                // auth_status_value.style.visibility = 'hidden';
                auth_status_value.style.color = "limegreen";
            }

            if (auth_status == true) {
                auth_status_value.textContent = "Success";
                auth_status_value.style.color = "limegreen";
            } else {
                auth_status_value.textContent = "Failed";
                auth_status_value.style.color = "crimson";
            }
        }

    </script>

</body>

</html>