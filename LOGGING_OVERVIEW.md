# Logging System - Complete Overview

This document provides a quick reference guide to the complete logging system implemented in Eyedeea Photos.

## Quick Start

### View Application Logs
```bash
# List all logs
npm run logs:list

# View specific log
npm run logs:view -- --file error.log

# Tail logs in real-time
npm run logs:tail -- --file info.log

# Get statistics
npm run logs:stats
```

### View PM2 Logs
```bash
# Real-time PM2 output
pm2 logs 'Eyedeea Photos'

# View specific PM2 log file
cat /var/log/EyediaTech/EyedeeaPhotos/pm2_app.log
```

---

## Log Files & Locations

### Application Logs

| File | Purpose | Platform | Location |
|------|---------|----------|----------|
| **error.log** | Errors and exceptions | Both | `{LOG_DIR}/error.log` |
| **info.log** | General info and events | Both | `{LOG_DIR}/info.log` |
| **debug.log** | Debug messages | Both | `{LOG_DIR}/debug.log` |
| **exceptions.log** | Uncaught exceptions | Both | `{LOG_DIR}/exceptions.log` |

**Log Directory**:
- **Windows**: `C:\Users\<username>\AppData\Local\EyediaTech\EyedeeaPhotos\logs\`
- **Linux**: `/var/log/EyediaTech/EyedeeaPhotos/`

### PM2 Process Logs

| File | Purpose | Location |
|------|---------|----------|
| **pm2_app.log** | Process stdout | `{LOG_DIR}/pm2_app.log` |
| **pm2_error.log** | Process stderr | `{LOG_DIR}/pm2_error.log` |

### Deployment Logs

| File | Purpose | Location | Trigger |
|------|---------|----------|---------|
| **auto-update.log** | Auto-update checks | `{ProjectRoot}/logs/auto-update.log` | Scheduled task/cron |

---

## Log Rotation

### Application Logs
- **Schedule**: Weekly (every 7 days)
- **Compression**: ZIP (level 9, 80-90% reduction)
- **Retention**: 4 weeks (auto-delete old archives)
- **Metadata**: Tracked in `.log.metadata` files
- **Management**: Automatic via background rotation checks

### PM2 Logs
- **Schedule**: Manual (no automatic rotation)
- **Compression**: None (use `pm2 flush` or manual rotation)
- **Retention**: User-managed
- **Management**: Use `logrotate` on Linux or scripts on Windows

### Auto-Update Logs
- **Schedule**: No rotation
- **Compression**: No compression
- **Retention**: User-managed
- **Management**: Manual cleanup or scheduled deletion

---

## Configuration Files

### Server Configuration
- **Logger Setup**: [server/config_log.js](server/config_log.js)
- **Log Rotation**: [server/utils/log-rotator.mjs](server/utils/log-rotator.mjs)
- **Constants**: [server/constants.js](server/constants.js) (log path definitions)

### PM2 Configuration
- **Sample**: [deployment/samples/ecosystem.config.js](deployment/samples/ecosystem.config.js)
- **Generated By**: [release/install.sh](release/install.sh) (Linux)
- **Location**: Created at application root during installation

### Deployment Configuration
- **Auto-Update**: [deployment/auto-update.mjs](deployment/auto-update.mjs)
- **Windows Task Setup**: [deployment/setup-task.ps1](deployment/setup-task.ps1)
- **Linux Cron Setup**: [deployment/setup-cron.sh](deployment/setup-cron.sh)

---

## Management Commands

### Application Log Management
```bash
# List all logs with sizes
npm run logs:list

# View a log file
npm run logs:view -- --file error.log
npm run logs:view -- --file info.log --lines 50

# Follow log in real-time
npm run logs:tail -- --file info.log

# Get log statistics
npm run logs:stats

# Force log rotation
npm run logs:rotate

# Clean old archives
npm run logs:clean
```

### PM2 Log Management
```bash
# View real-time logs
pm2 logs 'Eyedeea Photos'

# View specific log file
tail -f /var/log/EyediaTech/EyedeeaPhotos/pm2_app.log

# Clear logs
pm2 flush 'Eyedeea Photos'

# Save logs before rotation
pm2 save

# Reload logs
pm2 reload 'Eyedeea Photos'
```

### Deployment Log Management
```bash
# View auto-update log
tail -f $ProjectRoot/logs/auto-update.log

# Check recent updates
grep "Successfully installed" $ProjectRoot/logs/auto-update.log

# Monitor scheduled task (Windows)
Get-Content "$ProjectRoot\logs\auto-update.log" -Tail 50

# Monitor cron job (Linux)
grep auto-update /var/log/syslog | tail -20
```

---

## Troubleshooting

### Logs Not Being Created

**Check Log Directory**:
```bash
# Linux
ls -la /var/log/EyediaTech/EyedeeaPhotos/

# Windows PowerShell
Get-Item "C:\Users\$env:USERNAME\AppData\Local\EyediaTech\EyedeeaPhotos\logs" -Force
```

**Fix Permissions** (Linux):
```bash
sudo chmod 755 /var/log/EyediaTech/EyedeeaPhotos/
sudo chown $USER:$USER /var/log/EyediaTech/EyedeeaPhotos/
```

### Too Many Log Files

**Check Rotation Status**:
```bash
npm run logs:stats

# Check if archive files exist
ls -lh {LOG_DIR}/*.zip
```

**Manual Cleanup**:
```bash
npm run logs:clean

# Or manually
rm -f {LOG_DIR}/*.zip
```

### Permission Errors

**Windows**:
- Run scripts as Administrator
- Check folder ownership: `Get-Acl` command

**Linux**:
- Ensure user can write to log directory
- Check file ownership with `ls -l`
- Use `sudo` if needed for shared directories

### PM2 Logs Very Large

**Monitor Size**:
```bash
du -sh /var/log/EyediaTech/EyedeeaPhotos/pm2*.log
```

**Manual Rotation**:
```bash
# Backup old logs
tar -czf pm2_logs_backup_$(date +%Y%m%d).tar.gz /var/log/EyediaTech/EyedeeaPhotos/pm2*.log

# Clear PM2 logs
pm2 flush

# Restart app
pm2 restart 'Eyedeea Photos'
```

---

## Platform-Specific Notes

### Windows
- Logs stored in `AppData\Local` (not `AppData\Roaming`)
- Use PowerShell with Administrator privileges for setup
- PM2 uses default Windows locations
- Scheduled Task runs update checks automatically
- Log viewing: Use File Explorer or PowerShell `Get-Content`

### Linux
- Logs stored in `/var/log/` (system-wide)
- Requires `sudo` for `/var/log` access
- PM2 integrated with systemd for auto-startup
- Cron job runs update checks automatically
- Log viewing: Use `tail`, `less`, `grep` commands

---

## System Integration

### Startup & Shutdown
- **PM2 Process**: Auto-starts with system (via systemd/Task Scheduler)
- **Log Rotation**: Checks hourly in background
- **Auto-Updates**: Runs on schedule (configurable frequency)

### Monitoring
- **Log Growth**: Check via `npm run logs:stats`
- **PM2 Status**: Use `pm2 status` or `pm2 monit`
- **Update Status**: Check `auto-update.log`

### Backup & Recovery
- **Log Archives**: Stored in same directory as active logs
- **Rotation Metadata**: Stored in `.log.metadata` files
- **Recovery**: Compressed logs can be extracted with `unzip` or `tar`

---

## Documentation Reference

For detailed information, see:

1. **[LOGGING.md](LOGGING.md)** - Core logging setup and configuration
2. **[README_LOG_SYSTEM.md](README_LOG_SYSTEM.md)** - Application log system details
3. **[PM2_LOGGING.md](PM2_LOGGING.md)** - PM2 process manager logging
4. **[AUDIT_RELEASE_DEPLOYMENT_LOGS.md](AUDIT_RELEASE_DEPLOYMENT_LOGS.md)** - Script path audit
5. **[API_DOCUMENTATION.md](API_DOCUMENTATION.md)** - API endpoints (not logging-related)

---

## Best Practices

### General
- ✅ Check logs regularly for errors or warnings
- ✅ Monitor log directory disk usage
- ✅ Maintain clean audit trail with dated backups
- ✅ Document any log path customizations

### Security
- ✅ Restrict log directory access (contains potentially sensitive info)
- ✅ Rotate PM2 logs to prevent massive files
- ✅ Archive old logs to separate storage
- ✅ Implement log retention policies

### Performance
- ✅ Use `tail` with `--lines` to avoid loading huge files
- ✅ Compress and archive old logs regularly
- ✅ Monitor log rotation process overhead
- ✅ Consider remote log aggregation for production

---

## Quick Reference URLs

- GitHub Repo: [EyedeeaPhotos](https://github.com/your-org/eyedeeaphotos)
- Log System PR/Issue: [Link if available]
- Deployment Guide: [release/README.md](release/README.md)
- Server Setup: [server/README.md](server/README.md)

---

**Last Updated**: 2024-12-19  
**Version**: 2.0 (With PM2 and Release/Deployment audit)  
**Status**: ✅ Production Ready
